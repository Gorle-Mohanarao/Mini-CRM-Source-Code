<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Application</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/431189d21e.js" crossorigin="anonymous"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f3f4f6;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            padding: 2rem;
        }

        .card {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
    </style>
</head>

<body class="bg-gray-100">

    <div id="app" class="container">
        <!-- Main application content will be rendered here -->
    </div>

    <script>
        // Data storage using localStorage
        const STORAGE_KEY = 'crm_data';

        function getDB() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) {
                return JSON.parse(data);
            }
            // Pre-populate with initial data if localStorage is empty
            const initialData = {
                users: [{
                    id: 'u1',
                    name: 'Alice Rep',
                    email: 'rep@example.com',
                    password: 'password',
                    role: 'rep'
                }, {
                    id: 'u2',
                    name: 'Bob Manager',
                    email: 'manager@example.com',
                    password: 'password',
                    role: 'manager'
                }, {
                    id: 'u3',
                    name: 'Charlie Admin',
                    email: 'admin@example.com',
                    password: 'password',
                    role: 'admin'
                }],
                leads: [{
                    id: 'l1',
                    name: 'Bob Buyer',
                    email: 'bob@buyer.com',
                    phone: '999-999-9999',
                    status: 'New',
                    ownerId: 'u1'
                }, {
                    id: 'l2',
                    name: 'Sue Shopper',
                    email: 'sue@shopper.com',
                    phone: '888-888-8888',
                    status: 'Contacted',
                    ownerId: 'u1'
                }, {
                    id: 'l3',
                    name: 'Jane Prospect',
                    email: 'jane@prospect.com',
                    phone: '777-777-7777',
                    status: 'New',
                    ownerId: 'u2'
                }],
                opportunities: [{
                    id: 'o1',
                    title: 'Bob Buyer - First Deal',
                    value: 5000,
                    stage: 'Discovery',
                    ownerId: 'u1',
                    leadId: 'l1'
                }]
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(initialData));
            return initialData;
        }

        let db = getDB();

        function saveDB() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
        }

        // Global state
        let currentUser = null;
        let currentPage = 'login';
        let modal = null;
        let selectedLeadId = null;
        let selectedUserId = null;

        // Utility functions
        function generateId() {
            return Math.random().toString(36).substring(2, 9);
        }

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = '';
            if (!currentUser) {
                renderLoginPage(app);
            } else {
                renderHeader(app);
                if (currentPage === 'leads') {
                    renderLeadsPage(app);
                } else if (currentPage === 'opportunities') {
                    renderOpportunitiesPage(app);
                } else if (currentPage === 'admin-dashboard') {
                    renderAdminDashboard(app);
                }
            }
            if (modal) {
                app.appendChild(modal);
            }
        }

        // --- Render Functions ---

        function renderLoginPage(parent) {
            parent.innerHTML = `
                <div class="flex items-center justify-center h-screen bg-gray-100">
                    <div class="card w-96">
                        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">CRM Login</h1>
                        <form id="login-form">
                            <div class="mb-4">
                                <label for="email" class="block text-gray-700 font-medium mb-1">Email</label>
                                <input type="email" id="email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., rep@example.com" required>
                            </div>
                            <div class="mb-6">
                                <label for="password" class="block text-gray-700 font-medium mb-1">Password</label>
                                <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Password" required>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">Log In</button>
                        </form>
                    </div>
                </div>
            `;
            document.getElementById('login-form').addEventListener('submit', handleLogin);
        }

        function renderHeader(parent) {
            const header = document.createElement('header');
            header.className = 'flex justify-between items-center py-4 px-6 mb-6 bg-white shadow rounded-lg';
            header.innerHTML = `
                <div class="flex items-center space-x-4">
                    <span class="text-xl font-bold text-gray-800">My CRM</span>
                    <nav>
                        <ul class="flex space-x-4">
                            <li><a href="#" id="nav-leads" class="text-gray-600 hover:text-blue-600 font-medium transition-colors">Leads</a></li>
                            <li><a href="#" id="nav-opportunities" class="text-gray-600 hover:text-blue-600 font-medium transition-colors">Opportunities</a></li>
                            ${currentUser.role === 'admin' ? `<li><a href="#" id="nav-admin" class="text-gray-600 hover:text-blue-600 font-medium transition-colors">Admin Dashboard</a></li>` : ''}
                        </ul>
                    </nav>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-gray-700 font-medium">Hello, ${currentUser.name}</span>
                    <button id="logout-btn" class="bg-gray-200 text-gray-800 font-medium py-1 px-3 rounded-md hover:bg-gray-300 transition-colors">Log Out</button>
                </div>
            `;
            parent.appendChild(header);

            document.getElementById('nav-leads').addEventListener('click', (e) => {
                e.preventDefault();
                currentPage = 'leads';
                render();
            });
            document.getElementById('nav-opportunities').addEventListener('click', (e) => {
                e.preventDefault();
                currentPage = 'opportunities';
                render();
            });
            if (currentUser.role === 'admin') {
                document.getElementById('nav-admin').addEventListener('click', (e) => {
                    e.preventDefault();
                    currentPage = 'admin-dashboard';
                    render();
                });
            }
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
        }

        function renderLeadsPage(parent) {
            const leadsContainer = document.createElement('div');
            leadsContainer.className = 'card';
            const userLeads = currentUser.role === 'manager' || currentUser.role === 'admin' ? db.leads : db.leads.filter(lead => lead.ownerId === currentUser.id);

            leadsContainer.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">Leads</h2>
                    <button id="add-lead-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Add New Lead
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider rounded-tl-lg">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Owner</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider rounded-tr-lg">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="leads-table-body" class="divide-y divide-gray-200">
                            <!-- Leads will be rendered here -->
                        </tbody>
                    </table>
                </div>
            `;
            parent.appendChild(leadsContainer);

            const leadsTableBody = document.getElementById('leads-table-body');
            userLeads.forEach(lead => {
                const ownerName = db.users.find(u => u.id === lead.ownerId)?.name || 'N/A';
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${lead.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lead.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lead.status}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ownerName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex space-x-2">
                            <button data-id="${lead.id}" class="edit-lead-btn text-blue-600 hover:text-blue-900">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button data-id="${lead.id}" class="delete-lead-btn text-red-600 hover:text-red-900">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                            <button data-id="${lead.id}" class="convert-lead-btn text-green-600 hover:text-green-900 ${lead.status === 'Qualified' ? 'hidden' : ''}">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                        </div>
                    </td>
                `;
                leadsTableBody.appendChild(row);
            });

            document.getElementById('add-lead-btn').addEventListener('click', () => showAddEditLeadModal());
            document.querySelectorAll('.edit-lead-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                showAddEditLeadModal(db.leads.find(l => l.id === id));
            }));
            document.querySelectorAll('.delete-lead-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                showConfirmModal(`Are you sure you want to delete this lead?`, () => handleDeleteLead(id));
            }));
            document.querySelectorAll('.convert-lead-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                showConfirmModal(`Convert this lead to an opportunity?`, () => handleConvertLead(id));
            }));
        }

        function renderOpportunitiesPage(parent) {
            const oppsContainer = document.createElement('div');
            oppsContainer.className = 'card';
            const userOpps = currentUser.role === 'manager' || currentUser.role === 'admin' ? db.opportunities : db.opportunities.filter(opp => opp.ownerId === currentUser.id);

            oppsContainer.innerHTML = `
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Opportunities</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider rounded-tl-lg">Title</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Value</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Stage</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Owner</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider rounded-tr-lg">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="opps-table-body" class="divide-y divide-gray-200">
                            <!-- Opportunities will be rendered here -->
                        </tbody>
                    </table>
                </div>
            `;
            parent.appendChild(oppsContainer);

            const oppsTableBody = document.getElementById('opps-table-body');
            userOpps.forEach(opp => {
                const ownerName = db.users.find(u => u.id === opp.ownerId)?.name || 'N/A';
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${opp.title}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${opp.value.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${opp.stage}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ownerName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button data-id="${opp.id}" class="edit-opp-btn text-blue-600 hover:text-blue-900">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                oppsTableBody.appendChild(row);
            });

            document.querySelectorAll('.edit-opp-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                showEditOppModal(db.opportunities.find(o => o.id === id));
            }));
        }

        function renderAdminDashboard(parent) {
            const adminContainer = document.createElement('div');
            adminContainer.className = 'card';
            adminContainer.innerHTML = `
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Admin Dashboard</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider rounded-tl-lg">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Role</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider rounded-tr-lg">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body" class="divide-y divide-gray-200">
                            <!-- Users will be rendered here -->
                        </tbody>
                    </table>
                </div>
            `;
            parent.appendChild(adminContainer);

            const usersTableBody = document.getElementById('users-table-body');
            db.users.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.role}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button data-id="${user.id}" class="edit-user-btn text-blue-600 hover:text-blue-900 ${user.role === 'admin' && db.users.filter(u => u.role === 'admin').length === 1 ? 'hidden' : ''}">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                usersTableBody.appendChild(row);
            });

            document.querySelectorAll('.edit-user-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                showEditUserRoleModal(db.users.find(u => u.id === id));
            }));
        }

        // --- Modal Functions ---

        function showAddEditLeadModal(lead = null) {
            selectedLeadId = lead ? lead.id : null;
            const title = lead ? 'Edit Lead' : 'Add New Lead';
            const buttonText = lead ? 'Save Changes' : 'Add Lead';
            const leadStatusOptions = ['New', 'Contacted', 'Qualified'];

            const modalContent = document.createElement('div');
            modalContent.className = 'card w-11/12 md:w-1/2';
            modalContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">${title}</h3>
                    <button class="close-modal-btn text-gray-500 hover:text-gray-800"><i class="fas fa-times"></i></button>
                </div>
                <form id="lead-form">
                    <div class="mb-4">
                        <label for="lead-name" class="block text-gray-700 font-medium mb-1">Name</label>
                        <input type="text" id="lead-name" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="${lead ? lead.name : ''}" required>
                    </div>
                    <div class="mb-4">
                        <label for="lead-email" class="block text-gray-700 font-medium mb-1">Email</label>
                        <input type="email" id="lead-email" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="${lead ? lead.email : ''}" required>
                    </div>
                    <div class="mb-4">
                        <label for="lead-phone" class="block text-gray-700 font-medium mb-1">Phone</label>
                        <input type="tel" id="lead-phone" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="${lead ? lead.phone : ''}" required>
                    </div>
                    <div class="mb-6">
                        <label for="lead-status" class="block text-gray-700 font-medium mb-1">Status</label>
                        <select id="lead-status" class="w-full px-3 py-2 border border-gray-300 rounded-md" ${lead ? '' : 'disabled'}>
                            ${leadStatusOptions.map(status => `<option value="${status}" ${lead && lead.status === status ? 'selected' : ''}>${status}</option>`).join('')}
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">${buttonText}</button>
                </form>
            `;
            modal = createModal(modalContent);
            document.getElementById('lead-form').addEventListener('submit', handleAddEditLead);
            document.querySelector('.close-modal-btn').addEventListener('click', closeModal);
            render();
        }

        function showEditOppModal(opportunity) {
            const oppStages = ['Discovery', 'Proposal', 'Won', 'Lost'];

            const modalContent = document.createElement('div');
            modalContent.className = 'card w-11/12 md:w-1/2';
            modalContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Update Opportunity Stage</h3>
                    <button class="close-modal-btn text-gray-500 hover:text-gray-800"><i class="fas fa-times"></i></button>
                </div>
                <form id="opp-form">
                    <div class="mb-4">
                        <p class="text-gray-700 font-medium mb-2">Opportunity: <span class="font-bold">${opportunity.title}</span></p>
                        <label for="opp-stage" class="block text-gray-700 font-medium mb-1">Stage</label>
                        <select id="opp-stage" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                            ${oppStages.map(stage => `<option value="${stage}" ${opportunity.stage === stage ? 'selected' : ''}>${stage}</option>`).join('')}
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">Update Stage</button>
                </form>
            `;
            modal = createModal(modalContent);
            document.getElementById('opp-form').addEventListener('submit', (e) => handleUpdateOpp(e, opportunity.id));
            document.querySelector('.close-modal-btn').addEventListener('click', closeModal);
            render();
        }

        function showEditUserRoleModal(user) {
            selectedUserId = user.id;
            const roles = ['rep', 'manager', 'admin'];

            const modalContent = document.createElement('div');
            modalContent.className = 'card w-11/12 md:w-1/2';
            modalContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Update User Role</h3>
                    <button class="close-modal-btn text-gray-500 hover:text-gray-800"><i class="fas fa-times"></i></button>
                </div>
                <form id="user-role-form">
                    <div class="mb-4">
                        <p class="text-gray-700 font-medium mb-2">User: <span class="font-bold">${user.name}</span></p>
                        <label for="user-role" class="block text-gray-700 font-medium mb-1">Role</label>
                        <select id="user-role" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                            ${roles.map(role => `<option value="${role}" ${user.role === role ? 'selected' : ''}>${role}</option>`).join('')}
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">Update Role</button>
                </form>
            `;
            modal = createModal(modalContent);
            document.getElementById('user-role-form').addEventListener('submit', handleUpdateUserRole);
            document.querySelector('.close-modal-btn').addEventListener('click', closeModal);
            render();
        }

        function showConfirmModal(message, onConfirm) {
            const modalContent = document.createElement('div');
            modalContent.className = 'card w-11/12 md:w-1/3 text-center';
            modalContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Confirm Action</h3>
                    <button class="close-modal-btn text-gray-500 hover:text-gray-800"><i class="fas fa-times"></i></button>
                </div>
                <p class="text-gray-700 mb-6">${message}</p>
                <div class="flex justify-center space-x-4">
                    <button id="cancel-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-400">Cancel</button>
                    <button id="confirm-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-md hover:bg-red-700">Confirm</button>
                </div>
            `;
            modal = createModal(modalContent);
            document.getElementById('confirm-btn').addEventListener('click', () => {
                onConfirm();
                closeModal();
            });
            document.getElementById('cancel-btn').addEventListener('click', closeModal);
            document.querySelector('.close-modal-btn').addEventListener('click', closeModal);
            render();
        }

        function createModal(content) {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay';
            modalOverlay.appendChild(content);
            return modalOverlay;
        }

        function closeModal() {
            modal = null;
            selectedLeadId = null;
            selectedUserId = null;
            render();
        }

        // --- Event Handlers ---

        function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            const user = db.users.find(u => u.email === email && u.password === password);
            if (user) {
                currentUser = user;
                currentPage = 'leads';
                render();
            } else {
                alert('Invalid email or password.');
            }
        }

        function handleLogout() {
            currentUser = null;
            currentPage = 'login';
            render();
        }

        function handleAddEditLead(event) {
            event.preventDefault();
            const name = document.getElementById('lead-name').value;
            const email = document.getElementById('lead-email').value;
            const phone = document.getElementById('lead-phone').value;
            const status = document.getElementById('lead-status').value;

            if (selectedLeadId) {
                // Edit existing lead
                const leadIndex = db.leads.findIndex(l => l.id === selectedLeadId);
                if (leadIndex !== -1) {
                    db.leads[leadIndex] = { ...db.leads[leadIndex],
                        name,
                        email,
                        phone,
                        status
                    };
                }
            } else {
                // Add new lead
                db.leads.push({
                    id: generateId(),
                    name,
                    email,
                    phone,
                    status: 'New',
                    ownerId: currentUser.id
                });
            }
            saveDB();
            closeModal();
            render();
        }

        function handleDeleteLead(id) {
            db.leads = db.leads.filter(l => l.id !== id);
            saveDB();
            render();
        }

        function handleConvertLead(id) {
            const leadIndex = db.leads.findIndex(l => l.id === id);
            if (leadIndex !== -1) {
                const lead = db.leads[leadIndex];
                lead.status = 'Qualified';

                // Create new opportunity
                db.opportunities.push({
                    id: generateId(),
                    title: `${lead.name} - First Deal`,
                    value: 0,
                    stage: 'Discovery',
                    ownerId: lead.ownerId,
                    leadId: lead.id
                });
                saveDB();
                render();
            }
        }

        function handleUpdateOpp(event, id) {
            event.preventDefault();
            const stage = document.getElementById('opp-stage').value;
            const oppIndex = db.opportunities.findIndex(o => o.id === id);
            if (oppIndex !== -1) {
                db.opportunities[oppIndex].stage = stage;
                saveDB();
                closeModal();
                render();
            }
        }

        function handleUpdateUserRole(event) {
            event.preventDefault();
            const role = document.getElementById('user-role').value;
            const userIndex = db.users.findIndex(u => u.id === selectedUserId);
            if (userIndex !== -1) {
                db.users[userIndex].role = role;
                saveDB();
                closeModal();
                render();
            }
        }

        // Initial render on page load
        document.addEventListener('DOMContentLoaded', render);
    </script>
</body>

</html>
